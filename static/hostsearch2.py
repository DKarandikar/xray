# -*- coding: utf-8 -*-
import json
import re
import os
import urllib
import csv
import subprocess
from subprocess import Popen, PIPE, check_call

mobtrackers = ['Inmobi', 'Mopub', 'Facebook', 'Chartboost', 'Crashlytics', 'Heyzap', 'Applovin', 'Unitytechnologies', 'Vungle', 'Fyber', 'Millenialmedia', 'Ironsource', 'Tapjoy', 'Flurry', 'Google', 'Bitstadium', 'Presage', 'Comscore', 'Umeng', 'Tencent', 'Nexage', 'Mixpanel', 'Appboy', 'Yandex', 'Kochava', 'Urbanairship', 'Daum', 'Milkman', 'Playhaven', 'Umeng', 'Mail.Ru', 'Newrelic', 'Admob', 'Moat', 'Smaato', 'Admarvel', 'Appodeal', 'Cauley', 'Revmob', 'Adbuddiz', 'Igaworks', 'Nativex', 'Smartadserver', 'Mobfox', 'Pubnative', 'Hyprmx', 'Pingstart', 'Tune', 'Baidu', 'Swrve', 'Tnkfactory', 'Appnext', 'Tencent']
webtrackers = ['Google', 'Doubleclick', 'Facebook', 'Cloudfront', 'Scorecardresearch', 'Appnexus', 'Twitter', 'Amazon', 'Criteo', 'Yahoo', 'Oracle', 'Quantcast', 'Iponweb', 'Adobe', 'Openx', 'Ghostery', 'Rubicon', 'Bluekai', 'Cloudflare', 'Liveramp', 'The Nielsen Company', 'Demdex', 'Truste', 'Newrelic', 'Integral Ad Science', 'Adsrvr', 'Moatads', 'Pubmatic', 'Turn', 'Indexchange', 'Doubleverify', 'Mathtag', 'Chartbeat', 'Optimizely', 'Youtube', 'Tapad', 'Exelate', 'Targus', 'Lotame', 'Sizmek', 'Iasds', 'Neustar', 'Jquery', 'Krxd', 'Adroll', 'Brightroll', 'Audiencescience', 'Bootstrap', 'Rocketfuel', 'Dataxu', 'Tubemogul', 'Microsoft', 'Yandex', 'Conversant', 'Videology', 'Flashtalking', 'Akamai', 'Adap.Tv', 'Magnetic', 'Dstillery', 'Baidu', 'Smartadserver', 'Taboola', 'H&R Block', 'Tealium', 'Convertro', 'MSN', 'Linkedin', 'Mookie1', 'Contextweb', 'Liverail', 'Yadro', 'Bug', 'Chango', 'Conversant Llc', 'Trueffect', 'Signal-Privacy', 'Crazy Egg', 'Drawbridge Inc', 'Sovrn', 'Ovh', 'Exponential', 'Yieldoptimizer', 'Spotxchange', 'Owneriq', 'Insightexpress', 'Adform', 'Automattic', 'Disqus', 'Outbrain', 'Flipps', 'Centromedia', 'Ignitionone', 'Skimlinks', 'Simpli.Fi', 'Wordpress', 'Openx Technologies', 'Ensighten', 'Visual Website Optimizer', 'Rhythmone', 'Mixpanel', 'Sonobi', 'Hotjar', 'Voicefive', 'Gssprt', 'At Internet', 'Ml314', 'Radiumone', 'Parsely', 'Improve Digital Bv', 'Gumgum', 'Amgdgt', 'Effective Measure', 'Pinterest', 'Vk', 'Adition', 'Exoclick', 'Ixi Corporation', 'Nugg.Ad', 'Umeng', 'Alibaba', 'Marketo', 'Gskinner', 'Gigya', 'Tns', 'Eq Works', 'Cxense Asa', 'Steelhouse', 'Yieldlab', '33Across', 'Mail.Ru', 'Pingdom Ab', 'Smart Adserver', 'Brightcove', 'Postrelease', 'Adriver', 'Pagefair', 'Microad', 'Marin Software', 'Collective', 'Trafficjunky', 'Pixalate', 'Demandbase', 'Yieldbot', 'Visualdna', 'Ioam', 'Signal', 'Shopzilla', 'Sharethrough', 'Rambler', 'Clicktale', 'Sociomantic', 'Datonics', 'Run', 'Myspace', 'Taobao', 'Adgear Technologies', 'Sharethis', 'Mybuys', 'Stroeer Media', 'The Mcgraw-Hill Companies', 'Vizury', 'Abc', 'Dyn', 'Longtail Ad Solutions', 'Netseer', 'Smaato', 'The Adex Gmbh', 'Adblade', 'Mxptint', 'Maxymiser', 'Admeta', 'Mcro', 'Sourcepoint Technologies', 'Yieldmanager', 'Rfihub', 'Bounce Exchange', 'Wtp', 'Convertmedia', 'Rackspace Us', 'Eyeview', 'Qualtrics', 'Intent Iq', 'Stickyads.Tv', 'Soasta', 'Cedexis Inc', 'Weborama', 'Invite Media', 'Histats', 'Statcounter', 'Paypal', 'Bidr', 'Springserve', 'Yahoo', 'Nexstar Broadcasting', 'Triplelift', 'Polar', 'Adelphic Inc', 'Deep Forest Media', 'Cedexis', 'Richrelevance', 'Resonate', 'Impact-Ad', 'Jivox', 'Mediade', 'Liveperson', 'Zedo', 'Yabidos', 'Adfox', 'Fout', 'Switch', 'Navegg S.A.', 'Adsnative', 'Eyeota Limited', 'Jsdelivr', 'Consumerinfo.Com', 'Brandscreen Pty Ltd', 'Mythings', 'Polar Mobile Group', 'Answercloud', 'Komoona', 'Admeta', 'Meltdsp', 'Appier Inc', 'Netdna', 'Budgetedbauer', 'Gfk', 'Bidtheatre', 'Research Now', 'Undertone Networks', 'Viglink', 'Adbrain', 'Adstir', 'Sailthru', 'Vimeo', 'Mediametrie', 'Livefyre', 'Mediaforge', 'Webklipper', 'Tencent', 'Ib-Ibi']
trackers = set(mobtrackers)|set(webtrackers)
obj  = json.load(open('../mitm_out/company_details.json'))
toptrackers = obj.copy()
for tracker in trackers:
	if toptrackers[tracker]["id"] not in trackers:
		toptrackers.pop(tracker)

for tracker in toptrackers:
	domains = toptrackers[tracker]["domains"]
	fulldomains = filter(None, domains)
	toptrackers[tracker]["domains"] = fulldomains

def getDomainCo(host):
	for tracker in toptrackers:
		for domain in toptrackers[tracker]["domains"]:
			if domain in host:
				return toptrackers[tracker]["id"]

# open the text file which is output of grep, record any recognised domains in the output.json file

def recordTrackers(apkname, urlsname):
	urls = open(urlsname).read()
	trackers = []
	for tracker in toptrackers:
		for domain in toptrackers[tracker]["domains"]:
			if str(domain) in urls:
				trackers.append(str(tracker))
	trackers = list(set(trackers))
	print trackers
	irrelevant = ["app", "identity", "n/a", "other", "", "library"]
	for tracker in trackers:
		for cat in irrelevant:
			if (obj[tracker]["typetag"] == cat):
				trackers.remove(tracker)
				print 'removed %s because %s' % (tracker, obj[tracker]["typetag"])
	print trackers
	line = '"%s": %s,' % (apkname, json.dumps(trackers))
	output.write(line)

# # toptrackers = getPopTrackers()

output = open('output_testing.json', 'a')

directory = '../../apks/top/'

selectedApps1 = ['Cam.SILENT.apk', 'Com.sktelecom.minit.apk', 'Game.NDK.apk', 'Game.SpeedCar2.apk', 'Game.SpeedMoto.apk', 'HinKhoj.Dictionary.apk', 'SSGlobal.pack.apk', 'Uxpp.UC.apk', 'acogame.duoihinhbatchu.apk', 'afzkl.development.mVideoPlayer.apk', 'air.BRFree.apk', 'air.BattleofZombies.apk', 'air.BeautyCenter.apk', 'air.FSWeddingandroid.apk', 'air.FashionStudioPromDressDesign.apk', 'air.FlashStuntZ.apk', 'air.Hangman20.apk', 'air.KittyPrincessHairSalon.apk', 'air.KuninNikolay.RailwayBridge.Free.apk', 'air.MSPMobile.apk', 'air.QCHMOBILE.apk', 'air.air.com.jessoft.flvplayer.FLVPlayer.apk', 'air.au.com.metro.DumbWaysToDie.apk', 'air.balletdancer.apk', 'air.beingfashiondesigner.apk', 'air.br.com.bitlabs.FLVPlayer.apk', 'air.br.com.bitlabs.VideoPlayer.apk', 'air.byss.mobi.instaweatherfree.apk', 'air.cbn.superbook.bible.app.android.apk', 'air.charmycleanup.apk', 'air.coloringGamespaceship.apk', 'air.com.CleanUpHairSalon.apk', 'air.com.CreativeTech.LogicPuzzles.apk', 'air.com.FunPlusMore.RebuildACar.apk', 'air.com.PopcornMaker.apk', 'air.com.SuperCarWash.apk', 'air.com.adobe.connectpro.apk', 'air.com.arpamedia.preschoollearningprincessfun.apk', 'air.com.arpamedia.princessmermaidsalon.apk', 'air.com.arpamedia.princessspasalonfrozen.apk', 'air.com.axisentertainment.babyhazelgingerbreadhouse.apk', 'air.com.befunky.BeFunkyPhotoEditor.apk', 'air.com.bitrhymes.bingo.apk', 'air.com.blake.postcardAppAndroid.apk', 'air.com.cocosapps.HandDoctorTreatment.apk', 'air.com.cocosapps.LittleCuteBabyCare.apk', 'air.com.cocosapps.NurseBathing.apk', 'air.com.crescentmoongames.optical.apk', 'air.com.devgameapp.PrincessMakeoverSalon.apk', 'air.com.differencegames.threepyramidtripeaksfree.apk', 'air.com.dressupone.parishairsalon.apk', 'air.com.dressupone.thebadstudent.apk', 'air.com.eastsidegamestudio.PFGrassRoots.apk', 'air.com.enjoycookinggames.thumbelinagirldressup.apk', 'air.com.fde.kungfupandaandroid.apk', 'air.com.feerik.eredanbattle.apk', 'air.com.fictionlabs.apobondoehni.apk', 'air.com.flaregames.wordon.apk', 'air.com.games2win.fabtattooartist.apk', 'air.com.generamobile.colormaniaguess.apk', 'air.com.gerwinsoftware.superbuzzer.apk', 'air.com.goodgamestudios.shadowkings.apk', 'air.com.igg.perfectbraidhairdresser.apk', 'air.com.izmo.gercekgiydirme.apk', 'air.com.kitchenscramble.goo.apk', 'air.com.microcookinggames.icecreamconecupcake.apk', 'air.com.mobestmedia.letsescape.apk', 'air.com.mobigrow.canyouescape2.apk', 'air.com.mobigrow.canyouescapeadventure.apk', 'air.com.mobigrow.canyouescapetower.apk', 'air.com.netfunmedia.fairytaleprincesshairsalon.apk', 'air.com.netfunmedia.mermaidprincessspasalon.apk', 'air.com.nextdifferencegames.AdventureHiddenobjects.apk', 'air.com.nextdifferencegames.MysteryHiddenStory.apk', 'air.com.oak.OddSocksMob.apk', 'air.com.officemax.magicmirror.ElfYourSelf.apk', 'air.com.oranginalplan.weaphonesfree.apk', 'air.com.oranginalplan.weaphonesvol2free.apk', 'air.com.oranginalplan.weaphonesww2free.apk', 'air.com.peppapig.activitymaker.apk', 'air.com.playtika.slotomania.apk', 'air.com.sgn.cookiejam.gp.apk', 'air.com.smileydressup.fairydressup.apk', 'air.com.sticksports.sticktennis.apk', 'air.com.tamalaki.homemakeovertwo.gp.apk', 'air.com.tedven.youmustescape2.apk', 'air.com.tensquaregames.letsfish.apk', 'air.com.turbonuke.dirtbikeracing.apk', 'air.com.tutotoons.app.babyhouse.apk', 'air.com.tutotoons.app.misspastrychef.apk', 'air.com.tutotoons.app.sweetbabygirl.apk', 'air.com.ubisoft.csi.HiddenCrimes.apk', 'air.com.zyncstudio.PoolBabyCare.apk', 'air.cz.cfc.androidgp.AbbyBasicSkillsLite.apk', 'air.endlessescape.apk', 'air.fashionstudio.apk', 'air.fisherprice.com.Puppy.apk', 'air.fisherprice.com.animalsounds.apk', 'air.fisherprice.com.shapesAndColors.apk', 'air.isporch.apk', 'air.kazi.apk', 'air.meez.app.Towers.apk', 'air.mwe.cookingcuteheartcupcakes.apk', 'air.mwe.cookingsoftiesugarcookies.apk', 'air.mwe.supermacaroonscookinggames.apk', 'air.net.m7g7.MermaidBathing.apk', 'air.net.ozonedevelopment.AbbysHomeLaundry.apk', 'air.net.ozonedevelopment.BabyGirlsLaundry.apk', 'air.net.ozonedevelopment.CutePuppyCaring.apk', 'air.net.purplestudio.FarmingPrincess.apk', 'air.nn.mobile.app.main.apk', 'air.org.axisentertainment.BabyHazelBathroomHygiene.apk', 'air.org.axisentertainment.BabyHazelFarmTour.apk', 'air.org.axisentertainment.BabyHazelFlowerGirl.apk', 'air.org.axisentertainment.BabyHazelGardeningTime.apk', 'air.org.axisentertainment.BabyHazelGoesSick.apk', 'air.org.axisentertainment.BabyHazelKitchenTime.apk', 'air.org.axisentertainment.BabyHazelLegInjury.apk', 'air.org.axisentertainment.BabyHazelMischiefTime.apk', 'air.org.axisentertainment.BabyHazelMothersDay.apk', 'air.org.axisentertainment.BabyHazelNewbornBaby.apk', 'air.org.axisentertainment.BabyHazelPreschool.apk', 'air.org.axisentertainment.BabyHazelRoyalBath.apk', 'air.org.axisentertainment.BabyHazelSkinTrouble.apk', 'air.org.axisentertainment.BabyHazelStomachCare.apk', 'air.org.axisentertainment.BabyHazelSummerFun.apk', 'air.org.axisentertainment.BabyHazelSwimmingTime.apk', 'air.org.axisentertainment.SofysBabyShoppe.apk', 'air.princessroomdecoration.apk', 'air.prof.apk']
selectedApps2 = ['cc.dict.dictcc', 'com.dictionary', 'com.dictionary.bn', 'com.duckduckgo.mobile.android', 'com.ebooks.ebookreader', 'com.goodreads', 'com.merriamwebster', 'com.microsoft.bing', 'com.oup.gab.odquicksearch', 'com.scribd.app.reader0', 'com.tfd.mobile.TfdSearch', 'com.urbandictionary.android', 'org.freedictionary', 'org.leo.android.dict', 'org.wikipedia', 'com.cisco.webex.meetings', 'com.citrix.saas.gotowebinar', 'com.citrixonline.android.gotomeeting', 'com.fiverr.fiverr', 'com.indeed.android.jobsearch', 'com.jobkorea.app', 'com.timesgroup.timesjobs', 'com.monster.android.Views', 'naukriApp.appModules.login', 'net.infojobs.mobile.android', 'net.slideshare.mobile', 'com.crunchyroll.crmanga', 'com.dccomics.comics', 'com.marvel.comics', 'jp.comico', 'com.cinemex', 'com.eventbrite.attendee', 'com.imbc.mini', 'com.imdb.mobile', 'com.mobile.ign', 'com.netflix.mediaclient', 'com.ninegag.android.app', 'com.sonyliv', 'com.tudou.xoom.android', 'com.vimeo.android.videoapp', 'com.wikia.singlewikia.gta', 'com.wwe.universe', 'de.tvspielfilm', 'fr.m6.m6replay', 'tv.pps.mobile', 'au.com.nab.mobile', 'br.com.bb.android', 'br.com.gabba.Caixa', 'com.aastocks.dzh', 'com.akbank.android.apps.akbank_direkt', 'com.bca', 'com.bccard.mobilecard', 'com.bradesco', 'com.garanti.cepsubesi', 'com.hanaskcard.app.touchstamp', 'com.htsu.hsbcpersonalbanking', 'com.kbcard.cxh.appcard', 'com.kbstar.kbbank', 'com.paypal.android.p2pmobile', 'com.santander.app', 'com.sbi.SBIFreedomPlus', 'com.snapwork.hdfc', 'com.vakifbank.mobile', 'com.wf.wellsfargomobile', 'com.wooribank.pib.smart', 'com.wooricard.smartapp', 'com.yahoo.mobile.client.android.finance', 'fr.creditagricole.androidapp', 'gov.irs', 'info.percentagecalculator', 'pl.mbank', 'ru.tcsbank.mcp', 'se.bankgirot.swish', 'ua.privatbank.ap24', 'au.com.realestate.app', 'com.application.zomato', 'com.appsphere.innisfreeapp', 'com.aufeminin.marmiton.activities', 'com.cookpad.android.activities', 'com.done.faasos', 'com.dubizzle.horizontal', 'com.frenys.verdadoreto', 'com.global.foodpanda.android', 'com.gumtree.android', 'com.hotornot.app', 'com.houzz.app', 'com.ikea.catalogue.android', 'com.inditex.pullandbear', 'com.inditex.zara', 'com.kt.ollehfamilybox', 'com.move.realtor', 'com.openrice.snap', 'com.redfin.android', 'com.restaurant.mobile', 'com.rightmove.android', 'com.scripps.android.foodnetwork', 'com.trulia.android', 'com.trulia.android.rentals', 'com.zoopla.activity', 'de.mcdonalds.mcdonaldsinfoapp', 'de.pixelhouse', 'ecowork.seven', 'fr.disneylandparis.android', 'jp.co.recruit.mtl.android.hotpepper', 'kr.co.station3.dabang', 'com.AnatomyLearning.Anatomy3DViewer3', 'com.anghami', 'com.bandsintown', 'com.gaana', 'com.gaana.oldhindisongs', 'com.jangomobile.android', 'com.kugou.android', 'com.mixcloud.player', 'com.musixmatch.android.lyrify', 'com.spotify.music', 'com.vevo', 'de.radio.android', 'uk.co.sevendigital.android', 'com.abc.abcnews', 'com.andrewshu.android.reddit', 'com.backelite.vingtminutes', 'com.cnn.mobile.android.phone', 'com.dailymail.online', 'com.elpais.elpais', 'com.et.reader.activities', 'com.foxnews.android', 'com.google.android.apps.genie.geniewidget', 'com.hespress.android', 'com.huffingtonpost.android', 'com.ideashower.readitlater.pro', 'com.idmedia.android.newsportal', 'com.indomedia.tabpulsa', 'com.issuu.android.app', 'com.july.ndtv', 'com.makonda.blic', 'com.mobilesrepublic.appy', 'com.newspaperdirect.pressreader.android', 'com.newspaperdirect.pressreader.android.hc', 'com.nextmedia', 'com.nextmediatw', 'com.nextradiotv.bfmtvandroid', 'com.now.newsapp', 'com.nytimes.android', 'com.sumarya', 'com.tilab', 'com.Time', 'com.toi.reader.activities', 'com.usatoday.android.news', 'com.zing.znews', 'com.zinio.mobile.android.reader', 'com.zumobi.msnbc', 'de.cellular.focus', 'de.cellular.tagesschau', 'de.heute.mobile', 'de.lineas.lit.ntv.android', 'fr.lepoint.android', 'fr.playsoft.android.tv5mondev2', 'fr.playsoft.lefigarov3', 'id.co.babe', 'in.AajTak.headlines', 'net.aljazeera.english', 'net.trikoder.android.kurir', 'org.detikcom.rss', 'ru.rian.reader', 'se.sr.android', 'uk.co.economist', 'blibli.mobile.commerce', 'br.com.dafiti', 'com.acerstore.android', 'com.alibaba.aliexpresshd', 'com.appnana.android.giftcardrewards', 'com.asda.android', 'com.asos.app', 'com.ebay.kleinanzeigen', 'com.ebay.mobile', 'com.elevenst', 'com.elevenst.deals', 'com.etsy.android', 'com.flipkart.android', 'com.geomobile.tiendeo', 'com.goldtouch.ct.yad2', 'com.groupon', 'com.hmallapp', 'com.hnsmall', 'com.homeshop18.activity', 'com.interpark.shop', 'com.jabong.android', 'com.lamoda.lite', 'com.mercadolibre', 'com.mobisoft.morhipo', 'com.myntra.android', 'com.opensooq.OpenSooq', 'com.sahibinden', 'com.shopclues', 'com.shopping.limeroad', 'com.shpock.android', 'com.snapdeal.main', 'com.souq.app']

# selected apps version

for filename in selectedApps1:
	print filename
	fullpath = (directory + filename)
	print fullpath
	os.system("java -jar apktool.jar d %s.apk" % fullpath)
#	unpackedname = filename.rsplit( ".", 1 )[ 0 ]
	urlsname = "%s_urls.txt" % filename
	os.system('grep -Er "https?://[^ >]+" %s > %s' % (filename, urlsname))
#	os.system('grep -Er "iponweb" %s > %s' % (filename, urlsname))
#	os.system("grep -Er %s %s > %s" % ("http://\K[^']+", filename, urlsname))
	recordTrackers(filename,urlsname)
	os.system("rm -r %s" % filename)
	os.system("rm %s" % urlsname)